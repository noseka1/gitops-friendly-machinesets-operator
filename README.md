# GitOps-Friendly MachineSets Operator

This operator allows the user to manage MachineSets without the need to supply the cluster-specific infrastructure name. Infrastructure name is unique to the OpenShift cluster. It is generated by the OpenShift installer and is not known prior to the cluster installation. This operator injects the infrastructure name into MachineSets automatically.

## Building Container Images (Optional)

This section provides instructions for building your custom operator images. If you'd like to deploy the operator using pre-built images, you can continue to the next section.

Set the version you want to build. See `git tag` for available versions:

```
$ VERSION=0.1.0
```

Check out the tag:

```
$ git checkout $VERSION
```

Set the custom image names. Replace the image names below with your own:

```
$ IMG=quay.io/noseka1/gitops-friendly-machinesets-operator:$VERSION
$ IMAGE_TAG_BASE=quay.io/noseka1/gitops-friendly-machinesets-operator
```

Build operator image:

```
$ make docker-build IMG=$IMG
```

Push the finished operator image to the image registry:

```
$ podman push $IMG
```

Generate operator bundle artifacts:

```
$ make bundle IMG=$IMG CHANNELS=stable DEFAULT_CHANNEL=stable
```

Build bundle container image:

```
$ make bundle-build IMAGE_TAG_BASE=$IMAGE_TAG_BASE
```

Push bundle image to registry:

```
$ podman push $IMAGE_TAG_BASE-bundle:v$VERSION
```

Build catalog container image:

```
$ make catalog-build IMAGE_TAG_BASE=$IMAGE_TAG_BASE
```

Push catalog image to registry:

```
$ podman push $IMAGE_TAG_BASE-catalog:v$VERSION
```

## Deploying the Operator

If you'd like to deploy the operator using your custom built images, substitute the name of your catalog image in `deploy/gitops-friendly-machinesets-catsrc.yaml`:

```
$ sed -i "s#image:.*#image: $IMAGE_TAG_BASE-catalog:v$VERSION#" deploy/gitops-friendly-machinesets-catsrc.yaml
```

Alternatively, you can leverage the pre-built operator images to deploy the operator:

```
$ sed -i "s#image:.*#image: quay.io/noseka1/gitops-friendly-machinesets-operator-catalog:v0.1.0#" deploy/gitops-friendly-machinesets-catsrc.yaml
```

Deploy the operator:

```
$ oc apply -k deploy
```

## Creating a MachineSet

Create a MachineSet specific to your underlying infrastructure provider. For example, a MachineSet for AWS and vSphere may look like the ones below. Note that all occurences of the infrastructure name are marked using the INFRANAME token. Operator will replace this INFRANAME token with the real infrastructure name after the MachineSet manifest is applied.

Also note the two annotations that are required for the operator to take any action on the MachineSet:
1. Set `metadata.annotations.gitops-friendly-machinesets.redhat-cop.io/enabled: "true"`
2. Set `spec.template.metadata.annotations.gitops-friendly-machinesets.redhat-cop.io/enabled: "true"`

### Sample AWS MachineSet

```
apiVersion: machine.openshift.io/v1beta1
kind: MachineSet
metadata:
  annotations:
    gitops-friendly-machinesets.redhat-cop.io/enabled: "true"
  labels:
    machine.openshift.io/cluster-api-cluster: INFRANAME
  name: mymachineset
  namespace: openshift-machine-api
spec:
  replicas: 3
  selector:
    matchLabels:
      machine.openshift.io/cluster-api-cluster: INFRANAME
      machine.openshift.io/cluster-api-machineset: mymachineset
  template:
    metadata:
      annotations:
        gitops-friendly-machinesets.redhat-cop.io/enabled: "true"
      labels:
        machine.openshift.io/cluster-api-cluster: INFRANAME
        machine.openshift.io/cluster-api-machine-role: worker
        machine.openshift.io/cluster-api-machine-type: worker
        machine.openshift.io/cluster-api-machineset: mymachineset
    spec:
      metadata: {}
      providerSpec:
        value:
          ami:
            id: ami-03d9208319c96db0c
          apiVersion: awsproviderconfig.openshift.io/v1beta1
          blockDevices:
          - ebs:
              encrypted: true
              iops: 0
              kmsKey:
                arn: ""
              volumeSize: 120
              volumeType: gp2
          credentialsSecret:
            name: aws-cloud-credentials
          deviceIndex: 0
          iamInstanceProfile:
            id: INFRANAME-worker-profile
          instanceType: m5.xlarge
          kind: AWSMachineProviderConfig
          metadata:
            creationTimestamp: null
          placement:
            availabilityZone: us-east-2a
            region: us-east-2
          securityGroups:
          - filters:
            - name: tag:Name
              values:
              - INFRANAME-worker-sg
          subnet:
            filters:
            - name: tag:Name
              values:
              - INFRANAME-private-us-east-2a
          tags:
          - name: kubernetes.io/cluster/INFRANAME
            value: owned
          userDataSecret:
            name: worker-user-data
```

### Sample vSphere MachineSet

```
apiVersion: machine.openshift.io/v1beta1
kind: MachineSet
metadata:
  annotations:
    gitops-friendly-machinesets.redhat-cop.io/enabled: "true"
  labels:
    machine.openshift.io/cluster-api-cluster: INFRANAME
  name: mymachineset
  namespace: openshift-machine-api
spec:
  replicas: 3
  selector:
    matchLabels:
      machine.openshift.io/cluster-api-cluster: INFRANAME
      machine.openshift.io/cluster-api-machineset: mymachineset
  template:
    metadata:
      annotations:
        gitops-friendly-machinesets.redhat-cop.io/enabled: "true"
      labels:
        machine.openshift.io/cluster-api-cluster: INFRANAME
        machine.openshift.io/cluster-api-machine-role: worker
        machine.openshift.io/cluster-api-machine-type: worker
        machine.openshift.io/cluster-api-machineset: mymachineset
    spec:
      metadata: {}
      providerSpec:
        value:
          apiVersion: vsphereprovider.openshift.io/v1beta1
          credentialsSecret:
            name: vsphere-cloud-credentials
          diskGiB: 120
          kind: VSphereMachineProviderSpec
          memoryMiB: 32768
          metadata:
            creationTimestamp: null
          network:
            devices:
            - networkName: OpenShift Network
          numCPUs: 4
          numCoresPerSocket: 2
          snapshot: ""
          template: INFRANAME-rhcos
          userDataSecret:
            name: worker-user-data
          workspace:
            datacenter: Datacenter
            datastore: datastore1
            folder: /Datacenter/vm/mycluster
            resourcePool: /Datacenter/host/Cluster/Resources
            server: photon-machine.lab.example.com
```
